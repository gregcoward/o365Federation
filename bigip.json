{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"apiVersionCompute": {
			"type": "string",
			"metadata": {
				"description": "The compute api version"
			}
		},
		"apiVersionNetwork": {
			"type": "string",
			"metadata": {
				"description": "The network api version"
			}
		},
		"location": {
			"type": "string",
			"metadata": {
				"description": "The Azure location hosting the resource"
			}
		},
		"bigipNamePrefix": {
			"type": "string",
			"metadata": {
				"description": "The bigip name prefix"
			}
		},
		"adminUsername": {
			"type": "string",
			"metadata": {
				"description": "The admin account username"
			}
		},
		"adminPassword": {
			"type": "string",
			"metadata": {
				"description": "The admin account passowrd"
			}
		},
		"authenticationType": {
			"type": "string",
			"metadata": {
				"description": "Authentication method utilizeda"
			}
		},
		"sshPublicKey": {
			"type": "string",
			"metadata": {
				"description": "The ssh public key"
			}
		},
		"vmSize": {
			"type": "string",
			"metadata": {
				"description": "The bigip instance size"
			}
		},
		"availabilitySetName": {
			"type": "string",
			"metadata": {
				"description": "The bigip availability set"
			}
		},
		"subnetRef": {
			"type": "string",
			"metadata": {
				"description": "The subnet reference where bigip is hosted"
			}
		},
		"lbId": {
			"type": "string",
			"metadata": {
				"description": "The load balancer id"
			}
		},
		"newStorageAccountName": {
			"type": "string",
			"metadata": {
				"description": "The storage account hosting bigip"
			}
		},
		"copyCount": {
			"type": "int",
			"metadata": {
				"description": "The copyindex value"
			}
		}
	},
	"variables": {
		"nicNamePrefix": "bigip-nic",
		"sshKeyPath": "[concat('/home/',parameters('adminUsername'),'/.ssh/authorized_keys')]",
		"osProfileChosen": "[concat('osProfile', parameters('authenticationType'))]",
		"osProfilesshPublicKey": {
			"computerName": "[parameters('bigipNamePrefix')]",
			"adminUsername": "[parameters('adminUsername')]",
			"linuxConfiguration": {
				"disablePasswordAuthentication": "true",
				"ssh": {
					"publicKeys": [{
						"keyData": "[parameters('sshPublicKey')]",
						"path": "[variables('sshKeyPath')]"
					}]
				}
			}
		},
		"osProfilepassword": {
			"computerName": "[parameters('bigipNamePrefix')]",
			"adminUsername": "[parameters('adminUsername')]",
			"adminPassword": "[parameters('adminPassword')]"
		}
	},
	"resources": [{
		"apiVersion": "[parameters('apiVersionNetwork')]",
		"type": "Microsoft.Network/networkInterfaces",
		"name": "[concat(variables('nicNamePrefix'),parameters('copyCount'))]",
		"location": "[parameters('location')]",
		"tags": {
			"displayName": "NetworkInterface"
		},
		"dependsOn": [],
		"properties": {
			"ipConfigurations": [{
				"name": "ipconfig1",
				"properties": {
					"privateIPAllocationMethod": "Dynamic",
					"subnet": {
						"id": "[parameters('subnetRef')]"
					},
					"loadBalancerBackendAddressPools": [{
						"id": "[concat(parameters('lbId'), '/backendAddressPools/', 'loadBalancerBackEnd')]"
					}],

					"loadBalancerInboundNatRules": [{
						"id": "[concat(parameters('lbId'), '/inboundNatRules/', 'sshmgt', parameters('copyCount'))]"
					}, {
						"id": "[concat(parameters('lbId'), '/inboundNatRules/', 'guimgt', parameters('copyCount'))]"
					}]
				}
			}]
		}
	}, {
		"apiVersion": "[parameters('apiVersionCompute')]",
		"type": "Microsoft.Compute/virtualMachines",
		"name": "[concat(parameters('bigipNamePrefix'),parameters('copyCount'))]",
		"location": "[parameters('location')]",
		"tags": {
			"displayName": "BIG-IP"
		},
		"dependsOn": [
			"[concat('Microsoft.Network/networkInterfaces/', variables('nicNamePrefix'),parameters('copyCount'))]"
		],
		"plan": {
			"name": "f5-bigip-virtual-edition-best-byol",
			"publisher": "f5-networks",
			"product": "f5-big-ip"
		},
		"properties": {
			"availabilitySet": {
				"id": "[resourceId('Microsoft.Compute/availabilitySets',parameters('availabilitySetName'))]"
			},
			"hardwareProfile": {
				"vmSize": "[parameters('vmSize')]"
			},
			"osProfile": "[variables(variables('osProfileChosen'))]",
			"storageProfile": {
				"imageReference": {
					"publisher": "f5-networks",
					"offer": "f5-big-ip",
					"sku": "f5-bigip-virtual-edition-best-byol",
					"version": "latest"
				},
				"osDisk": {
					"name": "[concat('osdisk',parameters('bigipNamePrefix'))]",
					"vhd": {
						"uri": "[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/',variables('newStorageAccountName'),'/osDisk',parameters('bigipNamePrefix'),'.vhd')]"
					},
					"caching": "ReadWrite",
					"createOption": "FromImage"
				}
			},
			"networkProfile": {
				"networkInterfaces": [{
					"id": "[concat(resourceId('Microsoft.Network/networkInterfaces',variables('nicNamePrefix'),parameters('copyCount')))]"
				}]
			},
			"diagnosticsProfile": {
				"bootDiagnostics": {
					"enabled": true,
					"storageUri": "[concat('http://',parameters('newstorageAccountName'),'.blob.core.windows.net')]"
				}
			}
		}
	}],
	"outputs": {
		"bigip-ip": {
			"value": "[reference(concat(variables('nicNamePrefix'),parameters('copyCount'))).ipConfigurations[0].properties.privateIpAddress]",
			"type": "string"
		}
	}
}
